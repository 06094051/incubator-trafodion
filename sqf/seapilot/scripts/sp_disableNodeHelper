#!/bin/bash
# @@@ START COPYRIGHT @@@
#
# (C) Copyright 2010-2014 Hewlett-Packard Development Company, L.P.
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
#
# @@@ END COPYRIGHT @@@

# perform sanity check; we can't continue if MY_SQROOT is not set!

if [[ -z $MY_SQROOT ]]; then
    echo
    echo "*** ERROR: The MY_SQROOT environment variable does not exist."
    echo "Please ensure sqenv.sh has been sourced and re-run this script."
    echo
    exit 1;
fi


# modify various files to disable SeaPilot on the current node

sed -i 's/SQ_SEAPILOT_SUSPENDED=0/SQ_EVLOG_NONE=1/g' $MY_SQROOT/sqenvcom.sh
sed -i 's/SQ_SEAPILOT_SUSPENDED=0/SQ_EVLOG_NONE=1/g' $MY_SQROOT/sql/scripts/gomon.cold
sed -i 's/SQ_SEAPILOT_SUSPENDED=0/SQ_EVLOG_NONE=1/g' $MY_SQROOT/sql/scripts/gomon.warm
sed -i '/export SQ_START_SEAPILOT=1/d' $MY_SQROOT/sql/scripts/gomon.cold
sed -i '/export SQ_START_SEAPILOT=1/d' $MY_SQROOT/sql/scripts/gomon.warm

sed -i '/export SQ_SEAPILOT_PERF_SUSPENDED=0/d' $MY_SQROOT/sqenvcom.sh
sed -i '/set SQ_SEAPILOT_PERF_SUSPENDED=0/d' $MY_SQROOT/sql/scripts/gomon.cold
sed -i '/set SQ_SEAPILOT_PERF_SUSPENDED=0/d' $MY_SQROOT/sql/scripts/gomon.warm
sed -i '/export SQ_SEAPILOT_PERF_SUSPENDED=0/d' $MY_SQROOT/sql/scripts/gomon.cold
sed -i '/export SQ_SEAPILOT_PERF_SUSPENDED=0/d' $MY_SQROOT/sql/scripts/gomon.warm



# verify that the above file modifications were successful

SQ_SEAPILOT_SUSPENDED_COUNT_SQENVCOM_SH=$(grep -a 'SQ_SEAPILOT_SUSPENDED=0' $MY_SQROOT/sqenvcom.sh | wc -l)

if [[ $SQ_SEAPILOT_SUSPENDED_COUNT_SQENVCOM_SH -gt 0 ]]; then
    echo
    echo "*** ERROR: $MY_SQROOT/sqenvcom.sh was not successfully modified to disable SeaPilot."
    echo
fi

SQ_SEAPILOT_SUSPENDED_COUNT_GOMON_COLD=$(grep -a 'SQ_SEAPILOT_SUSPENDED=0' $MY_SQROOT/sql/scripts/gomon.cold | wc -l)
SQ_START_SEAPILOT_COUNT_GOMON_COLD=$(grep -a 'export SQ_START_SEAPILOT=1' $MY_SQROOT/sql/scripts/gomon.cold | wc -l)

if [[ $SQ_SEAPILOT_SUSPENDED_COUNT_GOMON_COLD -gt 0 || $SQ_START_SEAPILOT_COUNT_GOMON_COLD -gt 0 ]]; then
    echo
    echo "*** ERROR: $MY_SQROOT/sql/scripts/gomon.cold was not successfully modified to disable SeaPilot."
    echo
fi

SQ_SEAPILOT_SUSPENDED_COUNT_GOMON_WARM=$(grep -a 'SQ_SEAPILOT_SUSPENDED=0' $MY_SQROOT/sql/scripts/gomon.warm | wc -l)
SQ_START_SEAPILOT_COUNT_GOMON_WARM=$(grep -a 'export SQ_START_SEAPILOT=1' $MY_SQROOT/sql/scripts/gomon.warm | wc -l)

if [[ $SQ_SEAPILOT_SUSPENDED_COUNT_GOMON_WARM -gt 0 || $SQ_START_SEAPILOT_COUNT_GOMON_WARM -gt 0 ]]; then
    echo
    echo "*** ERROR: $MY_SQROOT/sql/scripts/gomon.warm was not successfully modified to disable SeaPilot."
    echo
fi
